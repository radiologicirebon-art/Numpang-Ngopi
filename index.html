<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Numpang Ngopi — Pemesanan</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const DB_URL = 'https://numpang-ngopi-crb-2c1b7-default-rtdb.firebaseio.com';
    const WA_PHONE = '628984290300';

    const MENU = {
      "Coffe": [
        { id: 'kopi-susu-aren', name: 'Kopi Susu Gula Aren', price: 8000 },
        { id: 'kopi-susu-latte', name: 'Kopi Susu Latte', price: 8000 },
        { id: 'americano', name: 'Americano', price: 6000 },
        { id: 'capuchino', name: 'Capuchino', price: 10000 },
        { id: 'taro-coffe', name: 'Taro Coffee', price: 10000 }
      ],
      "Non Coffe": [
        { id: 'taro-latte', name: 'Taro Latte', price: 8000 },
        { id: 'coklat-latte', name: 'Coklat Latte', price: 8000 },
        { id: 'redvelvet-latte', name: 'Redvelvet Latte', price: 8000 }
      ],
      "Addons": [
        { id: 'creamy', name: 'Creamy', price: 1000 },
        { id: 'aren', name: 'Aren', price: 1000 },
        { id: 'es-batu', name: 'Es Batu', price: 1000 }
      ]
    };

    function currency(n){
      return 'Rp' + n.toLocaleString('id-ID');
    }

    function App(){
      const [cart, setCart] = React.useState(()=>{
        try{
          const raw = localStorage.getItem('numpang_cart');
          return raw ? JSON.parse(raw) : [];
        }catch{ return []; }
      });
      const [sending, setSending] = React.useState(false);
      const [lastResult, setLastResult] = React.useState(null);

      React.useEffect(()=>{
        localStorage.setItem('numpang_cart', JSON.stringify(cart));
      },[cart]);

      function addToCart(item){
        setCart(prev => [...prev, { ...item, qty: 1, addons: [] }]);
      }

      function changeQty(index, delta){
        setCart(prev => {
          const copy = [...prev];
          copy[index].qty = Math.max(1, copy[index].qty + delta);
          return copy;
        });
      }

      function toggleAddon(index, addon){
        setCart(prev => {
          const copy = [...prev];
          const found = copy[index].addons || [];
          const pos = found.indexOf(addon.id);
          if(pos === -1) found.push(addon.id);
          else found.splice(pos,1);
          copy[index].addons = found;
          return copy;
        });
      }

      function removeItem(index){
        setCart(prev => prev.filter((_,i)=>i!==index));
      }

      function itemSubtotal(ci){
        const addonSum = (ci.addons || []).reduce((s,aId)=>{
          const a = MENU.Addons.find(x=>x.id===aId);
          return s + (a ? a.price : 0);
        },0);
        return (ci.price + addonSum) * ci.qty;
      }

      function total(){
        return cart.reduce((s,ci)=> s + itemSubtotal(ci), 0);
      }

      function buildMessage(){
        if(cart.length===0) return 'Halo saya ingin pesan, (belum ada item).';
        let lines = ['Halo, saya ingin pesan:'];
        cart.forEach(ci =>{
          const addons = (ci.addons||[]).map(aId => MENU.Addons.find(a=>a.id===aId)?.name).filter(Boolean);
          const addonsText = addons.length ? ` [${addons.join(', ')}]` : '';
          lines.push(`- ${ci.name} x${ci.qty}${addonsText} = ${currency(itemSubtotal(ci))}`);
        });
        lines.push(`Total pembayaran: ${currency(total())}`);
        lines.push('Terima kasih.');
        return lines.join('\n');
      }

      async function sendOrder(){
        if(cart.length===0) return alert('Keranjang kosong');
        setSending(true);
        const message = buildMessage();
        try{
          const payload = { message, cart, total: total(), createdAt: new Date().toISOString() };
          const res = await fetch(`${DB_URL}/orders.json`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const json = await res.json();
          setLastResult({ ok: res.ok, resp: json });
        }catch(err){
          setLastResult({ ok:false, error: String(err) });
        }
        const waText = encodeURIComponent(message);
        const waUrl = `https://wa.me/${WA_PHONE}?text=${waText}`;
        window.open(waUrl, '_blank');
        setSending(false);
      }

      return (
        <div className="min-h-screen bg-gray-50 p-6">
          <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6 grid md:grid-cols-2 gap-6">
            <div>
              <h1 className="text-2xl font-bold mb-4">Numpang Ngopi — Pemesanan</h1>
              <p className="text-sm text-gray-600 mb-4">Pilih menu, atur jumlah dan addons. Pesanan akan dikirim ke WhatsApp dan tersimpan di Firebase.</p>
              {Object.entries(MENU).filter(([k])=>k!=='Addons').map(([group, items])=> (
                <div key={group} className="mb-6">
                  <h2 className="font-semibold mb-2">{group}</h2>
                  <div className="grid grid-cols-2 gap-3">
                    {items.map(it=> (
                      <div key={it.id} className="border rounded p-3 flex flex-col justify-between">
                        <div>
                          <div className="font-medium">{it.name}</div>
                          <div className="text-sm text-gray-600">{currency(it.price)}</div>
                        </div>
                        <button onClick={()=>addToCart(it)} className="mt-3 px-3 py-1 bg-blue-600 text-white rounded">Tambah</button>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
              <div className="mt-4 text-xs text-gray-500">Addons: Creamy (1K), Aren (1K), Es Batu (1K).</div>
            </div>

            <div>
              <h2 className="text-lg font-semibold">Keranjang</h2>
              <div className="mt-3 space-y-3">
                {cart.length===0 && <div className="text-sm text-gray-500">Keranjang kosong.</div>}
                {cart.map((ci, idx) => (
                  <div key={idx} className="border rounded p-3">
                    <div className="flex justify-between items-start">
                      <div>
                        <div className="font-medium">{ci.name}</div>
                        <div className="text-sm text-gray-600">{currency(ci.price)}</div>
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={()=>changeQty(idx, -1)} className="px-2 py-1 border rounded">-</button>
                        <div>{ci.qty}</div>
                        <button onClick={()=>changeQty(idx, +1)} className="px-2 py-1 border rounded">+</button>
                      </div>
                    </div>
                    <div className="mt-2 text-sm">Addons:</div>
                    <div className="flex gap-2 mt-1 flex-wrap">
                      {MENU.Addons.map(ad => (
                        <label key={ad.id} className="text-sm flex items-center gap-1">
                          <input type="checkbox" checked={(ci.addons||[]).includes(ad.id)} onChange={()=>toggleAddon(idx, ad)} />
                          <span>{ad.name} (+{currency(ad.price)})</span>
                        </label>
                      ))}
                    </div>
                    <div className="mt-2 flex justify-between items-center">
                      <div className="text-sm text-gray-600">Subtotal: {currency(itemSubtotal(ci))}</div>
                      <button onClick={()=>removeItem(idx)} className="text-red-600 text-sm">Hapus</button>
                    </div>
                  </div>
                ))}
              </div>
              <div className="mt-4 border-t pt-4">
                <div className="flex justify-between">
                  <div className="font-medium">Total</div>
                  <div className="font-semibold">{currency(total())}</div>
                </div>
                <div className="mt-4 flex gap-2">
                  <button onClick={sendOrder} disabled={sending || cart.length===0} className="flex-1 py-2 rounded bg-green-600 text-white">{sending ? 'Mengirim...' : 'Kirim ke WhatsApp & Simpan'}</button>
                  <button onClick={()=>{ setCart([]); setLastResult(null); localStorage.removeItem('numpang_cart'); }} className="py-2 px-3 rounded border">Kosongkan</button>
                </div>
                {lastResult && (
                  <div className={`mt-3 text-sm ${lastResult.ok ? 'text-green-700' : 'text-red-700'}`}>
                    {lastResult.ok ? `Disimpan ke Firebase (key: ${lastResult.resp.name || '–'})` : `Gagal simpan: ${lastResult.error || JSON.stringify(lastResult.resp)}`}
                  </div>
                )}
              </div>
            </div>
          </div>
          <footer className="max-w-4xl mx-auto text-center mt-6 text-xs text-gray-500">Made for Numpang Ngopi. Crb — Mangkal's</footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
